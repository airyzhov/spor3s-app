#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Next.js Mini App –Ω–∞ VPS

echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Spor3s Mini App"
echo "================================"
echo ""

cd /var/www/spor3s-app

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã PM2 —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å Next.js
echo "1Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pm2 stop spor3s-nextjs 2>/dev/null || true
pm2 delete spor3s-nextjs 2>/dev/null || true
sleep 2

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Ä—Ç 3000 —Å–≤–æ–±–æ–¥–µ–Ω
echo ""
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 3000..."
if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null ; then
    echo "‚ö†Ô∏è –ü–æ—Ä—Ç 3000 –∑–∞–Ω—è—Ç, –æ—Å–≤–æ–±–æ–∂–¥–∞—é..."
    kill -9 $(lsof -t -i:3000) 2>/dev/null || true
    sleep 2
fi

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ .next –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo ""
echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏..."
if [ ! -d ".next" ]; then
    echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞—é —Å–±–æ—Ä–∫—É..."
    npm run build
else
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next –Ω–∞–π–¥–µ–Ω–∞"
fi

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å Next.js —á–µ—Ä–µ–∑ PM2
echo ""
echo "4Ô∏è‚É£ –ó–∞–ø—É—Å–∫ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 start npm --name "spor3s-nextjs" -- start
sleep 5

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
echo ""
echo "5Ô∏è‚É£ –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2:"
pm2 status

# 6. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
echo ""
echo "6Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2..."
pm2 save

# 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
echo ""
echo "7Ô∏è‚É£ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ (–ø–µ—Ä–≤—ã–µ 30 —Å—Ç—Ä–æ–∫):"
pm2 logs spor3s-nextjs --lines 30 --nostream

# 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo ""
echo "8Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
sleep 3
if curl -s http://localhost:3000 > /dev/null; then
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:3000"
else
    echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ù–ï –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:3000"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs spor3s-nextjs"
fi

# 9. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Nginx
echo ""
echo "9Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."
systemctl restart nginx
sleep 2
systemctl status nginx --no-pager | head -10

echo ""
echo "================================"
echo "‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:"
echo "  - –õ–æ–∫–∞–ª—å–Ω–æ: http://localhost:3000"
echo "  - –ß–µ—Ä–µ–∑ Nginx: https://ai.spor3s.ru"
echo ""
echo "–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - –õ–æ–≥–∏: pm2 logs spor3s-nextjs"
echo "  - –°—Ç–∞—Ç—É—Å: pm2 status"
echo "  - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: pm2 restart spor3s-nextjs"

