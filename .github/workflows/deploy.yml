name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          set -e
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è spor3s-app"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          if [ ! -d /var/www/spor3s-app ]; then
            echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /var/www/spor3s-app"
            mkdir -p /var/www/spor3s-app
            cd /var/www/spor3s-app
            git clone https://github.com/airyzhov/spor3s-app.git .
          else
            cd /var/www/spor3s-app
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          fi
          
          echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞..."
          if [ ! -f .env ]; then
            if [ -f .env.vps ]; then
              cp .env.vps .env
              echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω .env.vps –≤ .env"
            elif [ -f env-production ]; then
              cp env-production .env
              echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω env-production –≤ .env"
            else
              echo "‚ö†Ô∏è –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é"
            fi
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º .env –≤ –ø–æ–¥–ø—Ä–æ–µ–∫—Ç—ã
          if [ -f .env ]; then
            cp .env tg-bot/.env 2>/dev/null || true
            cp .env tg-client/.env.local 2>/dev/null || true
            echo "‚úÖ .env —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –ø–æ–¥–ø—Ä–æ–µ–∫—Ç—ã"
          fi
          
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞..."
          npm install
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ESLint –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -d node_modules/eslint ]; then
            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ESLint..."
            npm install --save-dev eslint eslint-config-next 2>/dev/null || true
          fi
          
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π tg-bot..."
          if [ -f tg-bot/package.json ]; then
            cd /var/www/spor3s-app/tg-bot
            npm install
            cd /var/www/spor3s-app
          fi
          
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π tg-client..."
          if [ -f tg-client/package.json ]; then
            cd /var/www/spor3s-app/tg-client
            npm install
            cd /var/www/spor3s-app
          fi
          
          echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          cd /var/www/spor3s-app
          
          # –£–¥–∞–ª—è–µ–º my-fresh-app –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -d my-fresh-app ]; then
            echo "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ my-fresh-app..."
            rm -rf my-fresh-app
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏
          export BUILD_DIR="/var/www/spor3s-app"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞..."
          ls -la /var/www/spor3s-app/ | head -20
          
          if [ -d spor3s-app/app ] && [ -f spor3s-app/package.json ]; then
            echo "üìÅ –ù–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π spor3s-app"
            export BUILD_DIR="/var/www/spor3s-app/spor3s-app"
          elif [ -d app ] && [ -f package.json ]; then
            echo "üìÅ –ù–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –∫–æ—Ä–Ω–µ"
            export BUILD_DIR="/var/www/spor3s-app"
          else
            echo "‚ö†Ô∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ app –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            APP_DIR=$(find /var/www/spor3s-app -type d -name "app" -maxdepth 3 | head -1)
            if [ -n "$APP_DIR" ]; then
              export BUILD_DIR=$(dirname "$APP_DIR")
              echo "üìÅ –ù–∞–π–¥–µ–Ω–∞ app –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤: $BUILD_DIR"
            else
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ app –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"
              ls -la /var/www/spor3s-app/
              exit 1
            fi
          fi
          
          cd "$BUILD_DIR"
          echo "üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $BUILD_DIR"
          echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
          ls -la | head -15
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ app –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ package.json
          if [ ! -d app ]; then
            echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è app –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ $BUILD_DIR"
            exit 1
          fi
          
          if [ ! -f package.json ]; then
            echo "‚ö†Ô∏è package.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $BUILD_DIR"
            exit 1
          fi
          
          echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–æ—É—Ç–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ—É—Ç–∞ /api/ai..."
          ROUTE_FILE=""
          if [ -f "$BUILD_DIR/app/api/ai/route.ts" ]; then
            ROUTE_FILE="$BUILD_DIR/app/api/ai/route.ts"
            echo "‚úÖ –†–æ—É—Ç –Ω–∞–π–¥–µ–Ω –≤ $BUILD_DIR/app/api/ai/route.ts"
          else
            # –ò—â–µ–º —Ä–æ—É—Ç –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
            FOUND_ROUTE=$(find "$BUILD_DIR" -name "route.ts" -path "*/api/ai/*" 2>/dev/null | head -1)
            if [ -n "$FOUND_ROUTE" ]; then
              echo "‚ö†Ô∏è –†–æ—É—Ç –Ω–∞–π–¥–µ–Ω –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ: $FOUND_ROUTE"
              echo "üìã –ö–æ–ø–∏—Ä—É—é —Ä–æ—É—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ..."
              mkdir -p "$BUILD_DIR/app/api/ai"
              cp "$FOUND_ROUTE" "$BUILD_DIR/app/api/ai/route.ts"
              ROUTE_FILE="$BUILD_DIR/app/api/ai/route.ts"
              echo "‚úÖ –†–æ—É—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ $ROUTE_FILE"
            else
              echo "‚ùå –†–æ—É—Ç app/api/ai/route.ts –ù–ï –ù–ê–ô–î–ï–ù –Ω–∏–≥–¥–µ!"
              exit 1
            fi
          fi
          
          if [ -n "$ROUTE_FILE" ] && [ -f "$ROUTE_FILE" ]; then
            ls -lh "$ROUTE_FILE"
            if grep -q "export async function POST" "$ROUTE_FILE"; then
              echo "‚úÖ –§—É–Ω–∫—Ü–∏—è POST —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞"
            else
              echo "‚ùå –§—É–Ω–∫—Ü–∏—è POST –ù–ï —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!"
              exit 1
            fi
          fi
          
          echo "üì¶ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π..."
          rm -rf "$BUILD_DIR/.next" 2>/dev/null || true
          rm -rf "$BUILD_DIR/node_modules/.cache" 2>/dev/null || true
          
          echo "üì¶ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ –≤ $BUILD_DIR..."
          npm run build 2>&1 | tee /tmp/build.log || {
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏!"
            tail -50 /tmp/build.log
            exit 1
          }
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–æ—É—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–ª—Å—è
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Ä–æ—É—Ç–∞ /api/ai..."
          if [ -d "$BUILD_DIR/.next/server/app/api/ai" ]; then
            echo "‚úÖ –†–æ—É—Ç /api/ai —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –≤ .next/server/app/api/ai"
            ls -la "$BUILD_DIR/.next/server/app/api/ai/" || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞"
          else
            echo "‚ö†Ô∏è –†–æ—É—Ç /api/ai –ù–ï –Ω–∞–π–¥–µ–Ω –≤ —Å–±–æ—Ä–∫–µ!"
            echo "–ü—Ä–æ–≤–µ—Ä—è—é –≤—Å–µ API —Ä–æ—É—Ç—ã:"
            find "$BUILD_DIR/.next/server/app/api" -name "route.js" -o -name "route.ts" 2>/dev/null | head -10 || echo "API —Ä–æ—É—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            echo "–ü—Ä–æ–≤–µ—Ä—è—é –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –Ω–∞ –æ—à–∏–±–∫–∏:"
            grep -i "api/ai\|route.ts\|error\|Error\|failed\|Failed" /tmp/build.log | tail -20 || echo "–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          fi
          
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ public/products..."
          # –ö–æ–ø–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω–∏ –≤ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          if [ -d /var/www/spor3s-app/spor3s-app/public/products ] && [ "$BUILD_DIR" != "/var/www/spor3s-app/spor3s-app" ]; then
            echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
            mkdir -p "$BUILD_DIR/public/products"
            cp -r /var/www/spor3s-app/spor3s-app/public/products/* "$BUILD_DIR/public/products/" 2>/dev/null || true
            echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          elif [ -d public/products ]; then
            echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —É–∂–µ –Ω–∞ –º–µ—Å—Ç–µ"
          fi
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENROUTER_API_KEY –ü–ï–†–ï–î –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º PM2
          echo "üîë –£—Å—Ç–∞–Ω–æ–≤–∫–∞ OPENROUTER_API_KEY..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –∏–∑ env –∏–ª–∏ fallback (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–ª–æ—è –±–µ–∑ GitHub Secrets)
          OPENROUTER_KEY="${OPENROUTER_API_KEY:-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}"
          echo "‚úÖ OPENROUTER_API_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–¥–ª–∏–Ω–∞: ${#OPENROUTER_KEY})"
          export OPENROUTER_API_KEY="$OPENROUTER_KEY"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤ .bashrc –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
          if ! grep -q "OPENROUTER_API_KEY" ~/.bashrc 2>/dev/null; then
            echo "export OPENROUTER_API_KEY=\"$OPENROUTER_KEY\"" >> ~/.bashrc
            echo "‚úÖ OPENROUTER_API_KEY –¥–æ–±–∞–≤–ª–µ–Ω –≤ ~/.bashrc"
          else
            sed -i "s|export OPENROUTER_API_KEY=.*|export OPENROUTER_API_KEY=\"$OPENROUTER_KEY\"|g" ~/.bashrc
            echo "‚úÖ OPENROUTER_API_KEY –æ–±–Ω–æ–≤–ª–µ–Ω –≤ ~/.bashrc"
          fi
          
          # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º .env.local —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –ü–ï–†–ï–î –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º PM2
          # Next.js –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç .env.local –≤ production
          cd "$BUILD_DIR"
          if [ -f .env.local ]; then
            if grep -q "OPENROUTER_API_KEY" .env.local; then
              sed -i "s|OPENROUTER_API_KEY=.*|OPENROUTER_API_KEY=$OPENROUTER_KEY|g" .env.local
              echo "‚úÖ OPENROUTER_API_KEY –æ–±–Ω–æ–≤–ª–µ–Ω –≤ .env.local"
            else
              echo "OPENROUTER_API_KEY=$OPENROUTER_KEY" >> .env.local
              echo "‚úÖ OPENROUTER_API_KEY –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env.local"
            fi
          else
            # –°–æ–∑–¥–∞–µ–º .env.local —Å –∫–ª—é—á–æ–º (–µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ)
            echo "OPENROUTER_API_KEY=$OPENROUTER_KEY" > .env.local
            echo "‚úÖ –°–æ–∑–¥–∞–Ω .env.local —Ñ–∞–π–ª —Å OPENROUTER_API_KEY"
          fi
          # –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º .env –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          if [ -f .env ]; then
            if grep -q "OPENROUTER_API_KEY" .env; then
              sed -i "s|OPENROUTER_API_KEY=.*|OPENROUTER_API_KEY=$OPENROUTER_KEY|g" .env
            else
              echo "OPENROUTER_API_KEY=$OPENROUTER_KEY" >> .env
            fi
          else
            echo "OPENROUTER_API_KEY=$OPENROUTER_KEY" > .env
          fi
          echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ .env.local:"
          grep "OPENROUTER_API_KEY" .env.local | head -1 | sed 's/OPENROUTER_API_KEY=\(.\{20\}\).*/OPENROUTER_API_KEY=\1.../' || echo "‚ö†Ô∏è OPENROUTER_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env.local"
          echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ .env.local (–ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤):"
          head -c 100 .env.local || echo "–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          echo ""
          cd /var/www/spor3s-app
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2 —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π .env.local —Ñ–∞–π–ª
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ .env.local..."
          pm2 restart spor3s-nextjs --update-env || {
            echo "‚ö†Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è, —É–¥–∞–ª—è—é –∏ —Å–æ–∑–¥–∞—é –∑–∞–Ω–æ–≤–æ..."
            pm2 delete spor3s-nextjs 2>/dev/null || true
            cd "$BUILD_DIR"
            pm2 start npm --name "spor3s-nextjs" -- start
          }
          sleep 5
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
          # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–µ–Ω—å –¥–ª—è PM2
          cd /var/www/spor3s-app
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENROUTER_API_KEY –ü–ï–†–ï–î –∑–∞–ø—É—Å–∫–æ–º PM2
          echo "üîë –£—Å—Ç–∞–Ω–æ–≤–∫–∞ OPENROUTER_API_KEY..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –∏–∑ env –∏–ª–∏ fallback (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–ª–æ—è –±–µ–∑ GitHub Secrets)
          OPENROUTER_KEY="${OPENROUTER_API_KEY:-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}"
          echo "‚úÖ OPENROUTER_API_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–¥–ª–∏–Ω–∞: ${#OPENROUTER_KEY})"
          export OPENROUTER_API_KEY="$OPENROUTER_KEY"
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
          pm2 delete all || true
          
          # –û–±–Ω–æ–≤–ª—è–µ–º ecosystem.config.js –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if [ -f ecosystem.config.js ]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ cwd —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            if [ "$BUILD_DIR" = "/var/www/spor3s-app/spor3s-app" ]; then
              echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ecosystem.config.js –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏..."
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π config, –Ω–æ —É–±–µ–¥–∏–º—Å—è —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            fi
          fi
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ ecosystem.config.js —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π OPENROUTER_API_KEY
          if [ -f ecosystem.config.js ]; then
            # –û–±–Ω–æ–≤–ª—è–µ–º cwd –≤ ecosystem.config.js –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if [ "$BUILD_DIR" != "/var/www/spor3s-app/spor3s-app" ]; then
              echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ cwd –≤ ecosystem.config.js..."
              sed -i "s|cwd: '/var/www/spor3s-app/spor3s-app'|cwd: '$BUILD_DIR'|g" ecosystem.config.js || true
            fi
            # –ó–∞–ø—É—Å–∫–∞–µ–º PM2 —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENROUTER_API_KEY
            echo "üöÄ –ó–∞–ø—É—Å–∫ PM2 —Å OPENROUTER_API_KEY..."
            OPENROUTER_API_KEY="$OPENROUTER_KEY" pm2 start ecosystem.config.js
          else
            echo "‚ö†Ô∏è ecosystem.config.js –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é..."
            cd "$BUILD_DIR"
            OPENROUTER_API_KEY="$OPENROUTER_KEY" pm2 start npm --name "spor3s-nextjs" -- start
            cd /var/www/spor3s-app
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤ .bashrc –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
          if ! grep -q "OPENROUTER_API_KEY" ~/.bashrc 2>/dev/null; then
            echo "export OPENROUTER_API_KEY=\"$OPENROUTER_KEY\"" >> ~/.bashrc
            echo "‚úÖ OPENROUTER_API_KEY –¥–æ–±–∞–≤–ª–µ–Ω –≤ ~/.bashrc"
          else
            sed -i "s|export OPENROUTER_API_KEY=.*|export OPENROUTER_API_KEY=\"$OPENROUTER_KEY\"|g" ~/.bashrc
            echo "‚úÖ OPENROUTER_API_KEY –æ–±–Ω–æ–≤–ª–µ–Ω –≤ ~/.bashrc"
          fi
          
          # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
          cd "$BUILD_DIR"
          if [ -f .env ]; then
            if grep -q "OPENROUTER_API_KEY" .env; then
              sed -i "s|OPENROUTER_API_KEY=.*|OPENROUTER_API_KEY=$OPENROUTER_KEY|g" .env
              echo "‚úÖ OPENROUTER_API_KEY –æ–±–Ω–æ–≤–ª–µ–Ω –≤ .env"
            else
              echo "OPENROUTER_API_KEY=$OPENROUTER_KEY" >> .env
              echo "‚úÖ OPENROUTER_API_KEY –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env"
            fi
          else
            echo "OPENROUTER_API_KEY=$OPENROUTER_KEY" > .env
            echo "‚úÖ –°–æ–∑–¥–∞–Ω .env —Ñ–∞–π–ª —Å OPENROUTER_API_KEY"
          fi
          cd /var/www/spor3s-app
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω
          sleep 3
          pm2 status
          echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API..."
          sleep 2
          curl -f http://localhost:3000/api/health || echo "‚ö†Ô∏è Health check failed"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          pm2 save
          
          echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
          pm2 status
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: https://ai.spor3s.ru"
