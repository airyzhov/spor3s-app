name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          set -e
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è spor3s-app"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          if [ ! -d /var/www/spor3s-app ]; then
            echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /var/www/spor3s-app"
            mkdir -p /var/www/spor3s-app
            cd /var/www/spor3s-app
            git clone https://github.com/airyzhov/spor3s-app.git .
          else
            cd /var/www/spor3s-app
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          fi
          
          echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞..."
          if [ ! -f .env ]; then
            if [ -f .env.vps ]; then
              cp .env.vps .env
              echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω .env.vps –≤ .env"
            elif [ -f env-production ]; then
              cp env-production .env
              echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω env-production –≤ .env"
            else
              echo "‚ö†Ô∏è –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é"
            fi
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º .env –≤ –ø–æ–¥–ø—Ä–æ–µ–∫—Ç—ã
          if [ -f .env ]; then
            cp .env tg-bot/.env 2>/dev/null || true
            cp .env tg-client/.env.local 2>/dev/null || true
            echo "‚úÖ .env —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –ø–æ–¥–ø—Ä–æ–µ–∫—Ç—ã"
          fi
          
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞..."
          npm install
          
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π tg-bot..."
          if [ -f tg-bot/package.json ]; then
            cd /var/www/spor3s-app/tg-bot
            npm install
            cd /var/www/spor3s-app
          fi
          
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π tg-client..."
          if [ -f tg-client/package.json ]; then
            cd /var/www/spor3s-app/tg-client
            npm install
            cd /var/www/spor3s-app
          fi
          
          echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          cd /var/www/spor3s-app
          
          # –£–¥–∞–ª—è–µ–º my-fresh-app –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -d my-fresh-app ]; then
            echo "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ my-fresh-app..."
            rm -rf my-fresh-app
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ app –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          if [ ! -d app ]; then
            echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è app –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
            ls -la
            exit 1
          fi
          
          echo "üì¶ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏..."
          npm run build
          
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ public/products..."
          if [ -d spor3s-app/public/products ]; then
            echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤..."
            mkdir -p public/products
            cp -r spor3s-app/public/products/* public/products/ 2>/dev/null || true
            echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          fi
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
          pm2 delete all || true
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ ecosystem.config.js
          pm2 start ecosystem.config.js
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          pm2 save
          
          echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
          pm2 status
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: https://ai.spor3s.ru"
