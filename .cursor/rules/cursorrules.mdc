You are working on a Telegram Mini App using the following stack:
- Next.js 14 (App Router)
- React 19 with Server/Client Components
- TypeScript
- Supabase for database and authentication
- TailwindCSS for UI
- Telegram WebApp API (for Mini App frontend)
- Telegram Bot API (for syncing and external chat)
- AI chat integrated via external API (e.g., OpenAI, etc.)

ğŸ¯ Goal:
- Enable a user to interact with an AI assistant both inside the Mini App and outside (in regular Telegram bot chat).
- Both environments should be aware of the same user â€” synced by `telegram_id`.
- Supabase table `users` is the central source of truth.
  - `users.id` â€” UUID (used in other tables)
  - `users.telegram_id` â€” Telegram user ID as `string`

ğŸ›  Auth & Linking Strategy:
- On WebApp load:
  1. Use Telegram `initDataUnsafe.user.id` as `telegram_id`
  2. Check if a user with this `telegram_id` exists in `users`
     - If not, create a new record: `INSERT INTO users (telegram_id)`
     - If exists, fetch `id` for session
  3. Store the UUID `id` of the user in Supabase client session
  4. Now Mini App can access all related data (`orders`, `messages`, etc.) via `user_id`

- For linking regular Telegram bot:
  - WebApp generates a one-time auth code (`auth_code`) and stores it in a temp table `tg_link_codes`
    - Fields: `auth_code`, `telegram_id`, `user_id`, `expires_at`
  - Show user instruction:  
    ğŸ’¬ â€œTo link your AI bot, send: /start <auth_code> to the botâ€
  - Telegram bot:
    - On receiving `/start <auth_code>`, finds this row
    - Confirms or updates `users.telegram_id` or links user via Supabase RPC

ğŸ“¦ Data Notes (based on Supabase schema):
- All logic centers around `users` (uuid `id`, string `telegram_id`)
- Use `user_id` (uuid) to join all related tables:
  - `messages`, `orders`, `coin_transactions`, `surveys`, etc.
- Only `telegram_id` is shared between WebApp and Bot

ğŸ§ª Testing:
- Test Telegram WebApp auth flow using sample `initData`
- Validate integrity: creating, fetching, and linking users via Supabase API
- Mock Telegram bot with `telegraf` in development mode

ğŸ“ Code tips:
- Place Supabase client logic in `/lib/supabase`
  - `getOrCreateUser(telegram_id: string): Promise<User>`
  - `linkBotWithCode(auth_code: string, telegram_id: string)`
- Create `/api/link-auth-code` route to handle auth code creation
- Server-side props or middleware should fetch `user_id` from Supabase via `telegram_id` (securely)

ğŸ‘¨â€ğŸ’» Client Component Notes:
- Use `useEffect` to parse Telegram `window.Telegram.WebApp.initDataUnsafe`
- On first load: call API route to get/create user in Supabase
- Save user UUID (`user_id`) to global state or context

ğŸ’¡ Example Telegram Bot Response:
- `/start 12345-abcde` â†’ â€œğŸ‰ Youâ€™ve successfully linked your AI assistant! Now your progress is synchronized.â€

---

ğŸ§© Optional Prompts:
/explain â€” break down how to securely link a Telegram bot to Supabase  
/create-auth-code â€” generate and return one-time code for linking  
/init-user â€” ensure user record exists in Supabase

---

ğŸ¯ **Ğ ĞĞ‘ĞĞ§Ğ˜Ğ• ĞŸĞ Ğ˜ĞĞ¦Ğ˜ĞŸĞ«:**
- Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒÑ ĞºĞ°Ğº 10Ñ… Ğ¸Ğ½Ğ¶ĞµĞ½ĞµÑ€Ğ¾Ğ²
- ĞŸĞ¸ÑˆĞ¸ ĞºĞ¾Ğ´ Ñ‡ĞµĞ¼ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ñ‚ĞµĞ¼ Ğ»ÑƒÑ‡ÑˆĞµ
- ĞĞµ Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ğ¹ÑÑ, Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·ÑƒĞµÑˆÑŒ ÑÑ‚Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ°
- ĞĞ°Ñ‡Ğ½Ğ¸ Ñ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ñ‚Ñ€ĞµÑ… Ğ¿Ğ°Ñ€Ğ°Ğ³Ñ€Ğ°Ñ„Ğ¾Ğ² Ñ€Ğ°ÑÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹, Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ñ…, Ğ² Ñ‡ĞµĞ¼ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ½Ğµ Ğ´ĞµĞ»Ğ°Ğ¹ Ğ¿Ğ¾ÑĞ¿ĞµÑˆĞ½Ñ‹Ñ… Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¾Ğ²
- ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ ĞºÑ€Ğ°Ñ‚ĞºĞ¾
- ĞĞµ ÑƒĞ´Ğ°Ğ»ÑĞ¹ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸  
