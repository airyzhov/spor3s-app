# üéØ –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê –í–°–ï–• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

## üìä –°–¥–µ–ª–∞–Ω–æ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏

### ‚úÖ –≠—Ç–∞–ø 1: –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–û–°–ù–û–í–ê)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç—ã –Ω–µ –ø–æ–º–Ω–∏–ª–∏ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞

**–†–µ—à–µ–Ω–∏–µ:**
- üîß **AI API** ‚Äî —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç `...msgs` –≤–º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ `userMessage`
- üîß **spor3s_bot** ‚Äî –ø–æ–ª—É—á–∞–µ—Ç `role + content` –∏–∑ –ë–î –≤–º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ `content`
- üîß **Mini App** ‚Äî –ø–µ—Ä–µ–¥–∞–µ—Ç `context` –º–∞—Å—Å–∏–≤ –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

**–§–∞–π–ª—ã:**
- `spor3s-app/app/api/ai/route.ts` ‚Äî —Å—Ç—Ä–æ–∫–∞ 628
- `tg-bot/bot.ts` ‚Äî —Å—Ç—Ä–æ–∫–∏ 516, 522-530
- `spor3s-app/app/(client)/chat.tsx` ‚Äî —Å—Ç—Ä–æ–∫–∏ 155-171

---

### ‚úÖ –≠—Ç–∞–ø 2: –ß–µ–ª–æ–≤–µ—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–º–ø—Ç –±—ã–ª —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–º

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úèÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –≤ `contentManager.ts`
- ‚öôÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∞ `temperature: 0.8` –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- üìù –£–≤–µ–ª–∏—á–µ–Ω—ã `max_tokens` –¥–æ 800

**–§–∞–π–ª—ã:**
- `spor3s-app/lib/contentManager.ts` ‚Äî —Å—Ç—Ä–æ–∫–∏ 20-68
- `spor3s-app/app/api/ai/route.ts` ‚Äî —Å—Ç—Ä–æ–∫–∞ 630-631

---

### ‚úÖ –≠—Ç–∞–ø 3: –°—Ç—Ä–æ–≥–∏–µ –∑–∞–ø—Ä–µ—Ç—ã (–§–ò–ù–ê–õ)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –≤—Å–µ –µ—â–µ –ø–æ–≤—Ç–æ—Ä—è–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
- üö´ –î–æ–±–∞–≤–ª–µ–Ω—ã **–°–¢–†–û–ì–ò–ï –ó–ê–ü–†–ï–¢–´** –≤ –ø—Ä–æ–º–ø—Ç
- üìã –î–æ–±–∞–≤–ª–µ–Ω—ã **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã** ‚ùå –∏ ‚úÖ
- üí° –Ø–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å "–ø–æ—Ä–æ—à–æ–∫" –ø–æ—Å–ª–µ "–µ–∂–æ–≤–∏–∫"

**–§–∞–π–ª—ã:**
- `spor3s-app/app/ai/scenarios.ts` ‚Äî –ø—É–Ω–∫—Ç 30
- `spor3s-app/lib/contentManager.ts` ‚Äî FALLBACK_PROMPT
- `update_ai_prompt_strict.sql` ‚Äî –¥–ª—è –ë–î

---

## üìÅ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
|------|---------------|
| `spor3s-app/app/api/ai/route.ts` | –ü–µ—Ä–µ–¥–∞—á–∞ msgs, temperature, max_tokens |
| `spor3s-app/lib/contentManager.ts` | –ü—Ä–æ–º–ø—Ç —Å –∑–∞–ø—Ä–µ—Ç–∞–º–∏ –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ |
| `spor3s-app/app/ai/scenarios.ts` | –ü—É–Ω–∫—Ç 30 —Å –ö–†–ò–¢–ò–ß–ù–´–ú–ò –∑–∞–ø—Ä–µ—Ç–∞–º–∏ |
| `tg-bot/bot.ts` | –ü–æ–ª—É—á–µ–Ω–∏–µ role+content –∏–∑ –ë–î |
| `spor3s-app/app/(client)/chat.tsx` | –ü–µ—Ä–µ–¥–∞—á–∞ context –≤ API |
| `update_ai_prompt_strict.sql` | SQL –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ Supabase |

---

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –í–°–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π

```bash
bash APPLY_FIX_NOW.sh
```

–°–∫—Ä–∏–ø—Ç:
1. ‚úÖ –°–∫–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ 5 —Ñ–∞–π–ª–æ–≤ –Ω–∞ VPS
2. ‚úÖ –ü–µ—Ä–µ—Å–æ–±–µ—Ä–µ—Ç Next.js
3. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –≤—Å–µ –∞–≥–µ–Ω—Ç—ã
4. ‚úÖ –ü–æ–∫–∞–∂–µ—Ç –ª–æ–≥–∏

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π

```bash
# 1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã
scp spor3s-app/app/api/ai/route.ts root@185.166.197.49:/var/www/spor3s-app/spor3s-app/app/api/ai/
scp spor3s-app/lib/contentManager.ts root@185.166.197.49:/var/www/spor3s-app/spor3s-app/lib/
scp spor3s-app/app/ai/scenarios.ts root@185.166.197.49:/var/www/spor3s-app/spor3s-app/app/ai/
scp tg-bot/bot.ts root@185.166.197.49:/var/www/spor3s-app/tg-bot/
scp -r "spor3s-app/app/(client)/chat.tsx" root@185.166.197.49:/var/www/spor3s-app/spor3s-app/app/\(client\)/

# 2. –ù–∞ VPS
ssh root@185.166.197.49
cd /var/www/spor3s-app
npm run build
pm2 restart all
pm2 logs --lines 50
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û–±–Ω–æ–≤–∏—Ç—å –ë–î –ø—Ä–æ–º–ø—Ç

```sql
-- –í Supabase Dashboard ‚Üí SQL Editor
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
update_ai_prompt_strict.sql
```

---

## üß™ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–º—ã
```
User: —Ö–æ—á—É –µ–∂–æ–≤–∏–∫
Bot: –û—Ç–ª–∏—á–Ω–æ! –ï–∂–æ–≤–∏–∫ –¥–ª—è –ø–∞–º—è—Ç–∏. –§–æ—Ä–º–∞: –∫–∞–ø—Å—É–ª—ã –∏–ª–∏ –ø–æ—Ä–æ—à–æ–∫?

User: –ø–æ—Ä–æ—à–æ–∫
Bot: –û—Ç–ª–∏—á–Ω–æ! –ï–∂–æ–≤–∏–∫ –≤ –ø–æ—Ä–æ—à–∫–µ 100–≥ ‚Äî 1100‚ÇΩ. –°—Ä–æ–∫: –º–µ—Å—è—Ü –∏–ª–∏ 3-6?

‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è:
   - –ù–ï–¢ "–ü—Ä–∏–≤–µ—Ç!"
   - –ù–ï–¢ "–Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç"
   - –ù–ï–¢ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   - –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—Ä–æ –µ–∂–æ–≤–∏–∫
```

### –¢–µ—Å—Ç 2: –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π
```
User: –ø—Ä–∏–≤–µ—Ç
Bot: –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?

User: –º—É—Ö–æ–º–æ—Ä
Bot: –ú—É—Ö–æ–º–æ—Ä –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ —Å–Ω–æ–º...

‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è:
   - –ù–ï–¢ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ "–ü—Ä–∏–≤–µ—Ç!"
```

### –¢–µ—Å—Ç 3: –ü–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```
User: —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ —Å–Ω–æ–º?
Bot: –ú—É—Ö–æ–º–æ—Ä –∫—Ä–∞—Å–Ω—ã–π...

User: –∞ –≤ –∫–∞–ø—Å—É–ª–∞—Ö –µ—Å—Ç—å?
Bot: –î–∞, –ú—É—Ö–æ–º–æ—Ä –≤ –∫–∞–ø—Å—É–ª–∞—Ö 60 —à—Ç ‚Äî 1100‚ÇΩ

‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è:
   - –ü–æ–Ω–∏–º–∞–µ—Ç —á—Ç–æ —Ä–µ—á—å –æ –º—É—Ö–æ–º–æ—Ä–µ
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä
npm run dev

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
node test-dialogs-simple.js
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –≤ –ª–æ–≥–∞—Ö

```bash
pm2 logs spor3s-bot --lines 100
```

**–ò—Å–∫–∞—Ç—å:**
```
‚úÖ [spor3s_bot] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ AI –∫–æ–Ω—Ç–µ–∫—Å—Ç: 5 —Å–æ–æ–±—â–µ–Ω–∏–π
‚úÖ [Mini App Chat] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç: 7 —Å–æ–æ–±—â–µ–Ω–∏–π
‚úÖ [AI API] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 7
‚úÖ [AI API] 1. user: —Ö–æ—á—É –µ–∂–æ–≤–∏–∫
‚úÖ [AI API] 2. assistant: –û—Ç–ª–∏—á–Ω–æ...
‚úÖ [AI API] 3. user: –ø–æ—Ä–æ—à–æ–∫
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚ùå [AI API] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 1
   (–æ–∑–Ω–∞—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è)
```

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –ß—Ç–æ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|-----|------|-------|
| **–ö–æ–Ω—Ç–µ–∫—Å—Ç** | –¢–æ–ª—å–∫–æ 1 —Å–æ–æ–±—â–µ–Ω–∏–µ | –í—Å—è –∏—Å—Ç–æ—Ä–∏—è (msgs) |
| **–†–æ–ª–∏ –≤ –ë–î** | –¢–æ–ª—å–∫–æ content | role + content |
| **Mini App** | –ë–µ–∑ context | –ü–µ—Ä–µ–¥–∞–µ—Ç context |
| **–ü—Ä–æ–º–ø—Ç** | "–ì–æ–≤–æ—Ä–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ" | "–ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å –ü—Ä–∏–≤–µ—Ç!" |
| **–ü—Ä–∏–º–µ—Ä—ã** | –ù–µ—Ç | –ï—Å—Ç—å ‚ùå –∏ ‚úÖ |
| **Temperature** | 0.7 | 0.8 |
| **Max tokens** | 600 | 800 |

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `FIX_AI_HUMAN_CHAT.md` | –ü–µ—Ä–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ |
| `FIX_CONTEXT_ALL_CHATS.md` | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö —á–∞—Ç–æ–≤ |
| `FINAL_FIX_NO_REPEAT.md` | –§–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–∫—Å –ø—Ä–æ—Ç–∏–≤ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π |
| `QUICK_FIX.txt` | –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è |
| `TEST_CONTEXT_ALL.md` | –¢–µ—Å—Ç-–∫–µ–π—Å—ã |
| `APPLY_FIX_NOW.sh` | –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è |

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –í—Å–µ 5 —Ñ–∞–π–ª–æ–≤ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ VPS
- [ ] npm run build –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] pm2 restart all –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
- [ ] pm2 status –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ online
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–µ—Ä–µ–¥–∞—á—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (>1 —Å–æ–æ–±—â–µ–Ω–∏–µ)
- [ ] –¢–µ—Å—Ç 1: –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ç–µ–º—É –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
- [ ] –¢–µ—Å—Ç 2: –Ω–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π
- [ ] –¢–µ—Å—Ç 3: –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
- [ ] –ü—Ä–æ–º–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Supabase (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

**üéâ –ì–æ—Ç–æ–≤–æ! –í—Å–µ —Ç—Ä–∏ —á–∞—Ç–∞ —Ç–µ–ø–µ—Ä—å –æ–±—â–∞—é—Ç—Å—è –∫–∞–∫ –∂–∏–≤—ã–µ –ª—é–¥–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π!**

