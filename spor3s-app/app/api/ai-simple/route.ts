import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  try {
    const { message, source, telegram_id } = await req.json();
    
    console.log("[AI SIMPLE] message:", message);
    console.log("[AI SIMPLE] source:", source);
    
    const messageSource = source || 'mini_app';
    const userMessage = message.toLowerCase();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –±–∞–ª–∞–Ω—Å–µ SC
    const balanceKeywords = ['–∫–æ–∏–Ω', '–±–∞–ª–ª', 'spor3s coin', '—Å–∫–æ–ª—å–∫–æ —É –º–µ–Ω—è', '–º–æ–π –±–∞–ª–∞–Ω—Å', '–º–æ–∏—Ö –∫–æ–∏–Ω–æ–≤', '–±–∞–ª–ª–æ–≤ —É –º–µ–Ω—è'];
    if (balanceKeywords.some(keyword => userMessage.includes(keyword))) {
      let balanceResponse = `Spor3s Coins (SC) ‚Äî —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ –Ω–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã! 
      
ü™ô **–ö–∞–∫ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å SC:**
‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —á–µ–∫–∏–Ω—ã 
‚Ä¢ –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –æ–ø—Ä–æ—Å–æ–≤
‚Ä¢ –ü–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

üí∞ **–ö–∞–∫ —Ç—Ä–∞—Ç–∏—Ç—å SC:**
‚Ä¢ –°–∫–∏–¥–∫–∏ –¥–æ 30% –æ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞
‚Ä¢ –û–±–º–µ–Ω –Ω–∞ —Ç–æ–≤–∞—Ä—ã

üì± **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å:** –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí —Ä–∞–∑–¥–µ–ª "–ü—Ä–æ–≥—Ä–µ—Å—Å"`;
      
      if (messageSource !== 'mini_app') {
        balanceResponse += '\n\n–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: üëâ t.me/spor3s_bot';
      }
      
      return NextResponse.json({ response: balanceResponse });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    if (userMessage.includes('–µ–∂–æ–≤–∏–∫')) {
      let response = `–û—Ç–ª–∏—á–Ω–æ! –ï–∂–æ–≤–∏–∫ –≥—Ä–µ–±–µ–Ω—á–∞—Ç—ã–π –æ—Ç–ª–∏—á–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å –ø–∞–º—è—Ç—å—é, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–µ–π –∏ –æ–±—É—á–µ–Ω–∏–µ–º.

–í –∫–∞–∫–æ–π —Ñ–æ—Ä–º–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ:
‚Ä¢ –ö–∞–ø—Å—É–ª—ã (—É–¥–æ–±–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å, 120 –∫–∞–ø—Å—É–ª –Ω–∞ –º–µ—Å—è—Ü –∑–∞ 1100‚ÇΩ)
‚Ä¢ –ü–æ—Ä–æ—à–æ–∫ (–±—ã—Å—Ç—Ä–µ–µ —ç—Ñ—Ñ–µ–∫—Ç, 100–≥ –Ω–∞ –º–µ—Å—è—Ü –∑–∞ 1100‚ÇΩ)

–ò –Ω–∞ –∫–∞–∫–æ–π —Å—Ä–æ–∫:
‚Ä¢ –ú–µ—Å—è—Ü (–¥–ª—è –Ω–∞—á–∞–ª–∞)
‚Ä¢ 3 –º–µ—Å—è—Ü–∞ (–∫—É—Ä—Å, —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ)
‚Ä¢ 6 –º–µ—Å—è—Ü–µ–≤ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)

–¢–∞–∫–∂–µ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ–ø—ã—Ç –ø—Ä–∏–µ–º–∞ –¥–æ–±–∞–≤–æ–∫ –∏–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç–µ –≤–ø–µ—Ä–≤—ã–µ?`;

      if (messageSource !== 'mini_app') {
        response += '\n\n–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: üëâ t.me/spor3s_bot';
      }
      
      return NextResponse.json({ response });
    }
    
    if (userMessage.includes('–º—É—Ö–æ–º–æ—Ä')) {
      let response = `–û—Ç–ª–∏—á–Ω–æ! –ú—É—Ö–æ–º–æ—Ä –æ—Ç–ª–∏—á–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ —Å–Ω–æ–º –∏ —Å–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–µ—Å—Å.

–í –∫–∞–∫–æ–π —Ñ–æ—Ä–º–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ:
‚Ä¢ –ö–∞–ø—Å—É–ª—ã (—É–¥–æ–±–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å, 60 –∫–∞–ø—Å—É–ª –Ω–∞ –º–µ—Å—è—Ü –∑–∞ 1400‚ÇΩ)
‚Ä¢ –ü–æ—Ä–æ—à–æ–∫ –∏–∑ —à–ª—è–ø–æ–∫ (–±—ã—Å—Ç—Ä–µ–µ —ç—Ñ—Ñ–µ–∫—Ç, 30–≥ –Ω–∞ –º–µ—Å—è—Ü –∑–∞ 1400‚ÇΩ)

–ò –Ω–∞ –∫–∞–∫–æ–π —Å—Ä–æ–∫:
‚Ä¢ –ú–µ—Å—è—Ü (–¥–ª—è –Ω–∞—á–∞–ª–∞)
‚Ä¢ 3 –º–µ—Å—è—Ü–∞ (–∫—É—Ä—Å, —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ)
‚Ä¢ 6 –º–µ—Å—è—Ü–µ–≤ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)

–¢–∞–∫–∂–µ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ–ø—ã—Ç –ø—Ä–∏–µ–º–∞ –¥–æ–±–∞–≤–æ–∫ –∏–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç–µ –≤–ø–µ—Ä–≤—ã–µ?`;

      if (messageSource !== 'mini_app') {
        response += '\n\n–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: üëâ t.me/spor3s_bot';
      }
      
      return NextResponse.json({ response });
    }
    
    // –ë–∞–∑–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    let response = `–ü—Ä–∏–≤–µ—Ç! –Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –≥—Ä–∏–±–Ω—ã–º –¥–æ–±–∞–≤–∫–∞–º –°–ü–û–†–°.
    
–£ –Ω–∞—Å –µ—Å—Ç—å:
üß† –ï–∂–æ–≤–∏–∫ –≥—Ä–µ–±–µ–Ω—á–∞—Ç—ã–π - –¥–ª—è –ø–∞–º—è—Ç–∏ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
üò¥ –ú—É—Ö–æ–º–æ—Ä –∫—Ä–∞—Å–Ω—ã–π - –¥–ª—è —Å–Ω–∞ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è  
üí™ –ö–æ—Ä–¥–∏—Ü–µ–ø—Å - –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏
ü¶ã –¶–∏—Å—Ç–æ–∑–∏—Ä–∞ - –¥–ª—è —â–∏—Ç–æ–≤–∏–¥–Ω–æ–π –∂–µ–ª–µ–∑—ã

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?`;

    if (messageSource !== 'mini_app') {
      response += '\n\n–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: üëâ t.me/spor3s_bot';
    }
    
    return NextResponse.json({ response });
    
  } catch (error) {
    console.error("[AI SIMPLE] Error:", error);
    const message = error instanceof Error ? error.message : 'Unknown error';
    return NextResponse.json({ 
      response: "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
      error: message
    }, { status: 500 });
  }
}
