// –£–õ–£–ß–®–ï–ù–ù–´–ô –ë–û–¢ –° –ü–†–ò–í–ï–¢–°–¢–í–ò–ï–ú –ò –ê–ö–¢–ò–í–ù–´–ú–ò –û–¢–í–ï–¢–ê–ú–ò
const { Telegraf } = require('telegraf');
const { createClient } = require('@supabase/supabase-js');
const axios = require('axios');
require('dotenv').config({ path: 'env.local' });

console.log('üöÄ –£–õ–£–ß–®–ï–ù–ù–´–ô –ë–û–¢ SPOR3S');
console.log('=' .repeat(60));

class ImprovedSpor3sBot {
  constructor() {
    this.bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN || '');
    this.supabase = createClient(
      process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
    );
    
    this.apiUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://ai.spor3s.ru';
    console.log('üåê API URL:', this.apiUrl);
    
    this.setupHandlers();
  }

  setupHandlers() {
    // –ö–æ–º–∞–Ω–¥–∞ /start —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
    this.bot.start(async (ctx) => {
      console.log('üì± /start –æ—Ç:', ctx.from.first_name);
      
      const welcomeMessage = `
üéâ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Spor3s!**

–Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥—Ä–∏–±–Ω—ã—Ö –¥–æ–±–∞–≤–æ–∫.

üçÑ **–ù–ê–®–ò –ü–†–û–î–£–ö–¢–´:**
‚Ä¢ **–ï–∂–æ–≤–∏–∫** ‚Äî —É–ª—É—á—à–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
‚Ä¢ **–ú—É—Ö–æ–º–æ—Ä** ‚Äî –∑–¥–æ—Ä–æ–≤—ã–π —Å–æ–Ω –∏ —Å–Ω—è—Ç–∏–µ —Å—Ç—Ä–µ—Å—Å–∞  
‚Ä¢ **–ö–æ—Ä–¥–∏—Ü–µ–ø—Å** ‚Äî –ø–æ–≤—ã—à–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏
‚Ä¢ **–ö—É—Ä—Å 4 –≤ 1** ‚Äî –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

üí° **–ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø:**
‚Ä¢ –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç
‚Ä¢ –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
‚Ä¢ –Ø –ø–æ–º–æ–≥—É —Å –≤—ã–±–æ—Ä–æ–º –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞

üîß **–ö–û–ú–ê–ù–î–´:**
/help ‚Äî —Å–ø—Ä–∞–≤–∫–∞
/test ‚Äî —Ç–µ—Å—Ç –±–æ—Ç–∞
/my_coins ‚Äî –º–æ–∏ –º–æ–Ω–µ—Ç—ã
/order ‚Äî –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑

**–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ!** ‚ú®
      `;
      
      await ctx.reply(welcomeMessage, { parse_mode: 'Markdown' });
      console.log('‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    });

    // –ö–æ–º–∞–Ω–¥–∞ /help
    this.bot.command('help', async (ctx) => {
      console.log('üì± /help –æ—Ç:', ctx.from.first_name);
      
      const helpMessage = `
üîß **–°–ü–†–ê–í–ö–ê SPOR3S BOT**

**–û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´:**
/start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/test ‚Äî —Ç–µ—Å—Ç —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
/my_coins ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –º–æ–Ω–µ—Ç
/order ‚Äî –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑

**–ß–¢–û –£–ú–ï–ï–¢ –ë–û–¢:**
‚Ä¢ –ü–æ–º–æ–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –≥—Ä–∏–±–Ω—ã–µ –¥–æ–±–∞–≤–∫–∏
‚Ä¢ –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
‚Ä¢ –ü–æ–º–æ–≥–∞–µ—Ç —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–æ–≤
‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤–∞—à–∏ –º–æ–Ω–µ—Ç—ã –∏ —Å–∫–∏–¥–∫–∏

**–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:**
‚Ä¢ "–†–∞—Å—Å–∫–∞–∂–∏ –æ –µ–∂–æ–≤–∏–∫–µ"
‚Ä¢ "–•–æ—á—É –∫—É–ø–∏—Ç—å –º—É—Ö–æ–º–æ—Ä"
‚Ä¢ "–ü–æ–º–æ–≥–∏ –≤—ã–±—Ä–∞—Ç—å –¥–æ–±–∞–≤–∫—É –¥–ª—è —Å–Ω–∞"
‚Ä¢ "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ—è—Ç –≤–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã?"

**–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ ‚Äî —è –æ—Ç–≤–µ—á—É –Ω–∞ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å!** ü§ñ
      `;
      
      await ctx.reply(helpMessage, { parse_mode: 'Markdown' });
      console.log('‚úÖ –°–ø—Ä–∞–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
    });

    // –ö–æ–º–∞–Ω–¥–∞ /test
    this.bot.command('test', async (ctx) => {
      console.log('üì± /test –æ—Ç:', ctx.from.first_name);
      await ctx.reply('‚úÖ **–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!** –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n\n–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã! ü§ñ', { parse_mode: 'Markdown' });
      console.log('‚úÖ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
    });

    // –ö–æ–º–∞–Ω–¥–∞ /my_coins
    this.bot.command('my_coins', async (ctx) => {
      console.log('üì± /my_coins –æ—Ç:', ctx.from.first_name);
      
      try {
        const userId = ctx.from.id.toString();
        const user = await this.getOrCreateUser(userId, ctx.from.first_name);
        
        // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –º–æ–Ω–µ—Ç
        const coins = await this.getUserCoins(user.id);
        
        await ctx.reply(`üí∞ **–í–∞—à –±–∞–ª–∞–Ω—Å:** ${coins} –º–æ–Ω–µ—Ç Spor3s\n\n–ú–æ–Ω–µ—Ç—ã –º–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ —Å–∫–∏–¥–∫–∏ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ!`, { parse_mode: 'Markdown' });
        console.log('‚úÖ –ë–∞–ª–∞–Ω—Å –º–æ–Ω–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–Ω–µ—Ç:', error);
        await ctx.reply('üí∞ **–í–∞—à –±–∞–ª–∞–Ω—Å:** 0 –º–æ–Ω–µ—Ç Spor3s\n\n–ù–∞—á–Ω–∏—Ç–µ –ø–æ–∫—É–ø–∞—Ç—å, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–æ–Ω–µ—Ç—ã!', { parse_mode: 'Markdown' });
      }
    });

    // –ö–æ–º–∞–Ω–¥–∞ /order
    this.bot.command('order', async (ctx) => {
      console.log('üì± /order –æ—Ç:', ctx.from.first_name);
      
      const orderMessage = `
üõí **–û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê**

–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:

1Ô∏è‚É£ **–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç** ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å
2Ô∏è‚É£ **–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ** ‚Äî —Å–∫–æ–ª—å–∫–æ —É–ø–∞–∫–æ–≤–æ–∫ –Ω—É–∂–Ω–æ
3Ô∏è‚É£ **–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã** ‚Äî –§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω, –∞–¥—Ä–µ—Å

**–ü–û–ü–£–õ–Ø–†–ù–´–ï –ü–†–û–î–£–ö–¢–´:**
‚Ä¢ –ï–∂–æ–≤–∏–∫ ‚Äî –¥–ª—è –ø–∞–º—è—Ç–∏
‚Ä¢ –ú—É—Ö–æ–º–æ—Ä ‚Äî –¥–ª—è —Å–Ω–∞
‚Ä¢ –ö–æ—Ä–¥–∏—Ü–µ–ø—Å ‚Äî –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏
‚Ä¢ –ö—É—Ä—Å 4 –≤ 1 ‚Äî –∫–æ–º–ø–ª–µ–∫—Å

**–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å, –∏ —è –ø–æ–º–æ–≥—É —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º!** ‚ú®
      `;
      
      await ctx.reply(orderMessage, { parse_mode: 'Markdown' });
      console.log('‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–∫–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –í–°–ï–• —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è)
    this.bot.on('text', async (ctx) => {
      const message = ctx.message.text;
      const userId = ctx.from.id.toString();
      const userName = ctx.from.first_name;
      
      console.log(`üì± "${message}" –æ—Ç ${userName}`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
      const greetings = ['–ø—Ä–∏–≤–µ—Ç', '–ø—Ä–∏–≤', '—Ö–∞–π', 'hello', 'hi', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '–¥–æ–±—Ä—ã–π –¥–µ–Ω—å', '–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä', '–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ'];
      const isGreeting = greetings.some(greeting => 
        message.toLowerCase().includes(greeting.toLowerCase())
      );
      
      if (isGreeting) {
        const greetingResponse = `
üëã **–ü—Ä–∏–≤–µ—Ç, ${userName}!**

–†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å! –Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Spor3s.

üçÑ **–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å:**
‚Ä¢ –í—ã–±—Ä–∞—Ç—å –≥—Ä–∏–±–Ω—ã–µ –¥–æ–±–∞–≤–∫–∏
‚Ä¢ –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
‚Ä¢ –ü–æ–º–æ—á—å —Å –∑–∞–∫–∞–∑–æ–º
‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã

**–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç!** ‚ú®

*–ù–∞–ø—Ä–∏–º–µ—Ä: "–†–∞—Å—Å–∫–∞–∂–∏ –æ –µ–∂–æ–≤–∏–∫–µ" –∏–ª–∏ "–•–æ—á—É –∫—É–ø–∏—Ç—å –º—É—Ö–æ–º–æ—Ä"*
        `;
        
        await ctx.reply(greetingResponse, { parse_mode: 'Markdown' });
        console.log('‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        return;
      }
      
      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
        const processingMsg = await ctx.reply('ü§ñ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...');
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = await this.getOrCreateUser(userId, userName);
        console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user.id);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await this.saveMessage(user.id, 'user', message, 'telegram_bot');
        console.log('üíæ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        const context = await this.getUserContext(user.id);
        console.log('üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç:', context.messages?.length || 0, '—Å–æ–æ–±—â–µ–Ω–∏–π');
        
        // –í—ã–∑—ã–≤–∞–µ–º AI API
        console.log('ü§ñ –í—ã–∑—ã–≤–∞–µ–º AI API...');
        const aiResponse = await this.callAI(message, context);
        console.log('‚úÖ AI –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç AI
        await this.saveMessage(user.id, 'assistant', aiResponse, 'telegram_bot');
        console.log('üíæ –û—Ç–≤–µ—Ç AI —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
        
        // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
        try {
          await ctx.telegram.deleteMessage(ctx.chat.id, processingMsg.message_id);
        } catch (e) {
          console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏');
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await ctx.reply(aiResponse, { parse_mode: 'Markdown' });
        console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error.message);
        
        // –£–ª—É—á—à–µ–Ω–Ω—ã–π fallback –æ—Ç–≤–µ—Ç
        const fallbackResponse = `
–ü—Ä–∏–≤–µ—Ç, ${userName}! üëã

–Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Spor3s. –ü–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å –≥—Ä–∏–±–Ω—ã–µ –¥–æ–±–∞–≤–∫–∏:

üçÑ **–ï–∂–æ–≤–∏–∫** ‚Äî –¥–ª—è –ø–∞–º—è—Ç–∏ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
üò¥ **–ú—É—Ö–æ–º–æ—Ä** ‚Äî –¥–ª—è —Å–Ω–∞ –∏ —Å–Ω—è—Ç–∏—è —Å—Ç—Ä–µ—Å—Å–∞  
‚ö° **–ö–æ—Ä–¥–∏—Ü–µ–ø—Å** ‚Äî –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏
üåü **–ö—É—Ä—Å 4 –≤ 1** ‚Äî –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?** –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:
‚Ä¢ "–†–∞—Å—Å–∫–∞–∂–∏ –æ –µ–∂–æ–≤–∏–∫–µ"
‚Ä¢ "–•–æ—á—É –∫—É–ø–∏—Ç—å –º—É—Ö–æ–º–æ—Ä"
‚Ä¢ "–ü–æ–º–æ–≥–∏ –≤—ã–±—Ä–∞—Ç—å –¥–æ–±–∞–≤–∫—É"

*–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏* üìö
        `;
        
        await ctx.reply(fallbackResponse, { parse_mode: 'Markdown' });
        console.log('‚úÖ Fallback –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      }
    });
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async getOrCreateUser(telegramId, name) {
    try {
      const { data: existingUser } = await this.supabase
        .from('users')
        .select('*')
        .eq('telegram_id', telegramId)
        .single();

      if (existingUser) {
        return existingUser;
      }

      const { data: newUser } = await this.supabase
        .from('users')
        .insert([{
          telegram_id: telegramId,
          name: name || 'Unknown',
          created_at: new Date().toISOString()
        }])
        .select()
        .single();

      return newUser;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ getOrCreateUser:', error);
      return { id: `temp-${telegramId}`, telegram_id: telegramId };
    }
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –º–æ–Ω–µ—Ç
  async getUserCoins(userId) {
    try {
      const { data: transactions } = await this.supabase
        .from('coin_transactions')
        .select('amount, type')
        .eq('user_id', userId);

      if (!transactions) return 0;

      let balance = 0;
      transactions.forEach(transaction => {
        if (transaction.type === 'earned') {
          balance += transaction.amount;
        } else if (transaction.type === 'spent') {
          balance -= transaction.amount;
        }
      });

      return Math.max(0, balance);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–Ω–µ—Ç:', error);
      return 0;
    }
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  async saveMessage(userId, role, content, source) {
    try {
      await this.supabase
        .from('messages')
        .insert([{
          user_id: userId,
          role: role,
          content: content,
          source: source,
          created_at: new Date().toISOString()
        }]);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    }
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async getUserContext(userId) {
    try {
      const { data: messages } = await this.supabase
        .from('messages')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(10);

      return {
        messages: messages || [],
        user_id: userId
      };
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:', error);
      return { messages: [], user_id: userId };
    }
  }

  // –í—ã–∑–æ–≤ AI API —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
  async callAI(message, context) {
    try {
      console.log('ü§ñ –í—ã–∑—ã–≤–∞–µ–º AI API:', `${this.apiUrl}/api/ai`);
      
      const response = await axios.post(`${this.apiUrl}/api/ai`, {
        message,
        context: context?.messages || [],
        source: 'telegram_bot',
        user_id: context?.user_id || null
      }, {
        headers: { 
          'Content-Type': 'application/json',
          'ngrok-skip-browser-warning': 'true',
          'User-Agent': 'spor3s-bot/1.0'
        },
        timeout: 15000
      });
      
      console.log('üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
      
      if (response.status !== 200) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = response.data;
      console.log('‚úÖ AI –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω');
      
      return data.response || data.reply || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.';
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ AI API:', error.message);
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –æ—Ç–≤–µ—Ç
      return `–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Spor3s. 

–ü–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å –≥—Ä–∏–±–Ω—ã–µ –¥–æ–±–∞–≤–∫–∏:

üçÑ **–ï–∂–æ–≤–∏–∫** ‚Äî –¥–ª—è –ø–∞–º—è—Ç–∏ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
üò¥ **–ú—É—Ö–æ–º–æ—Ä** ‚Äî –¥–ª—è —Å–Ω–∞ –∏ —Å–Ω—è—Ç–∏—è —Å—Ç—Ä–µ—Å—Å–∞  
‚ö° **–ö–æ—Ä–¥–∏—Ü–µ–ø—Å** ‚Äî –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? –ù–∞–ø–∏—à–∏—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:
‚Ä¢ "–†–∞—Å—Å–∫–∞–∂–∏ –æ –µ–∂–æ–≤–∏–∫–µ"
‚Ä¢ "–•–æ—á—É –∫—É–ø–∏—Ç—å –º—É—Ö–æ–º–æ—Ä"`;
    }
  }

  // –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
  async start() {
    try {
      await this.bot.launch();
      console.log('üöÄ –£–õ–£–ß–®–ï–ù–ù–´–ô –ë–û–¢ –ó–ê–ü–£–©–ï–ù!');
      console.log('üì± –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
      console.log('üí° –ö–æ–º–∞–Ω–¥—ã: /start, /help, /test, /my_coins, /order');
      console.log('üéØ –ë–æ—Ç —Ç–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è!');
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', error);
    }
  }

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
  async stop() {
    await this.bot.stop();
    console.log('üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  }
}

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if (require.main === module) {
  const bot = new ImprovedSpor3sBot();
  
  bot.start().catch(error => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', error);
  });

  // Graceful shutdown
  process.once('SIGINT', () => bot.stop('SIGINT'));
  process.once('SIGTERM', () => bot.stop('SIGTERM'));
}

module.exports = { ImprovedSpor3sBot };
