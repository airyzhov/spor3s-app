# üß† –ù–∞—Å—Ç—Ä–æ–π–∫–∞ RAG —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üìã –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Supabase**
- ‚úÖ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–æ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `messages`
- ‚úÖ –ü–æ–ª–µ `role` —Ä–∞–∑–ª–∏—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`user`) –∏ –±–æ—Ç–∞ (`assistant`)
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ `user_id` –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

### 2. **–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–∫–∞–∑–æ–≤ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–µ–º –≤ –¥–∏–∞–ª–æ–≥–∞—Ö
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—á–µ–∫–∏–Ω—ã, –∞–Ω–∫–µ—Ç—ã)
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª—é–±–∏–º—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤

### 3. **RAG —Å–∏—Å—Ç–µ–º–∞**
- ‚úÖ –ü–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –∏–∑ –ë–î
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

## üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
```sql
-- –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤ Supabase SQL Editor
-- –§–∞–π–ª: fix_messages_table.sql

-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ role –≤ —Ç–∞–±–ª–∏—Ü—É messages
ALTER TABLE messages 
ADD COLUMN IF NOT EXISTS role TEXT DEFAULT 'user';

-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
UPDATE messages 
SET role = 'user' 
WHERE role IS NULL;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX IF NOT EXISTS idx_messages_user_role 
ON messages(user_id, role);

-- –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è messages
DROP POLICY IF EXISTS "Users can view their own messages" ON messages;
CREATE POLICY "Users can view their own messages" ON messages
    FOR SELECT USING (auth.uid()::text = user_id::text);

DROP POLICY IF EXISTS "Users can insert their own messages" ON messages;
CREATE POLICY "Users can insert their own messages" ON messages
    FOR INSERT WITH CHECK (auth.uid()::text = user_id::text);
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü
```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ç–∞–±–ª–∏—Ü
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('users', 'orders', 'messages', 'surveys', 'daily_checkins', 'products', 'instructions');

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã messages
SELECT column_name, data_type, is_nullable, column_default 
FROM information_schema.columns 
WHERE table_name = 'messages' 
ORDER BY ordinal_position;
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
```
http://localhost:3000/test-user-profile.html
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API endpoints
```bash
# –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
curl -X POST http://localhost:3000/api/ai \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"user","content":"—Ç–µ—Å—Ç"}],"user_id":"test-123"}'

# –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
curl http://localhost:3000/api/user-profile?user_id=test-123
```

## üìä –ß—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

### 1. **–ó–∞–∫–∞–∑—ã –∏ –ø–æ–∫—É–ø–∫–∏**
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤
- –û–±—â–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫
- –õ—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–ø–æ —á–∞—Å—Ç–æ—Ç–µ –∑–∞–∫–∞–∑–æ–≤)
- –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞

### 2. **–î–∏–∞–ª–æ–≥–∏ —Å AI**
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–æ—Ç–∞
- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã (–º—É—Ö–æ–º–æ—Ä, –µ–∂–æ–≤–∏–∫, –∑–∞–∫–∞–∑, –¥–æ—Å—Ç–∞–≤–∫–∞ –∏ —Ç.–¥.)
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### 3. **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∞–Ω–∫–µ—Ç
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —á–µ–∫–∏–Ω–æ–≤
- –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)

### 4. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è**
- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º
- –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è

## üéØ –ö–∞–∫ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ AI

### 1. **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è**
```typescript
// AI –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
[–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø]
–ó–∞–∫–∞–∑–æ–≤: 3, –æ–±—â–∞—è —Å—É–º–º–∞: 4500‚ÇΩ, –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑: 15.01.2024
–°–æ–æ–±—â–µ–Ω–∏–π: 25 (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: 12, –±–æ—Ç: 13)
–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 2 –∞–Ω–∫–µ—Ç—ã, 5 —á–µ–∫–∏–Ω–æ–≤, –∞–∫—Ç–∏–≤–µ–Ω
–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã: –º—É—Ö–æ–º–æ—Ä(8), –∑–∞–∫–∞–∑(5), –¥–æ—Å—Ç–∞–≤–∫–∞(3)
–õ—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: mhm30(2), ezh120k(1)
```

### 2. **–£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–∞—Å—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –º—É—Ö–æ–º–æ—Ä–µ ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–æ–≤—ã–µ —Ñ–æ—Ä–º—ã
- –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –¥–æ—Å—Ç–∞–≤–∫–µ
- –ï—Å–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —á–µ–∫–∏–Ω –∏–ª–∏ –∞–Ω–∫–µ—Ç—É

### 3. **RAG –ø–æ–∏—Å–∫**
- –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö

## üîß –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### 1. –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
```javascript
// –í API AI route.ts
console.log('[AI API] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Supabase:', {
  user_id,
  userMessage,
  aiResponse
});
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT * FROM messages 
WHERE user_id = 'your-user-id' 
ORDER BY created_at DESC;

-- –ê–Ω–∞–ª–∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–µ–º
SELECT 
  COUNT(*) as count,
  CASE 
    WHEN content ILIKE '%–º—É—Ö–æ–º–æ—Ä%' THEN '–º—É—Ö–æ–º–æ—Ä'
    WHEN content ILIKE '%–µ–∂–æ–≤–∏–∫%' THEN '–µ–∂–æ–≤–∏–∫'
    WHEN content ILIKE '%–∑–∞–∫–∞–∑%' THEN '–∑–∞–∫–∞–∑'
    ELSE '–¥—Ä—É–≥–æ–µ'
  END as topic
FROM messages 
WHERE user_id = 'your-user-id'
GROUP BY topic
ORDER BY count DESC;
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

### 1. **–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
- AI –ø–æ–º–Ω–∏—Ç –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∏–∞–ª–æ–≥–∏
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
- RAG —Å–∏—Å—Ç–µ–º–∞ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –Ω–æ–≤—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 3. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**
- –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ê–Ω–∞–ª–∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–µ–º –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∑–∞—â–∏—â–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 3. **–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å**
- –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É
- –°–æ–±–ª—é–¥–µ–Ω–∏–µ GDPR –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é** `fix_messages_table.sql` –≤ Supabase
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É** —á–µ—Ä–µ–∑ `test-user-profile.html`
3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
4. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
5. **–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏** –≤ —Ç–∞–±–ª–∏—Ü—É `instructions` –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ 