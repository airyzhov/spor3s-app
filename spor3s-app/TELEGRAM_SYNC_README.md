# 🤖 СИНХРОНИЗАЦИЯ TELEGRAM БОТА И MINI APP

## 🎯 Цель проекта

Синхронизировать работу ИИ агента между Telegram Mini App и личным аккаунтом @web3grow, чтобы пользователь мог:

- Общаться с ИИ агентом в обоих средах
- Оформлять заказы через чат
- Синхронизировать историю сообщений
- Получать уведомления о заказах
- Использовать единую систему Spor3s Coins

## 🏗️ Архитектура системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Mini App      │    │   Telegram Bot  │    │   Supabase DB   │
│   (Frontend)    │◄──►│   @web3grow     │◄──►│   (Backend)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   AI Chat API   │    │   Order API     │    │   Messages      │
│   /api/ai       │    │   /api/order    │    │   Orders        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 📋 Требования

### Переменные окружения

Создайте файл `.env` в корне проекта:

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# OpenRouter (AI)
OR_TOKEN=your_openrouter_token

# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token
MANAGER_CHAT_ID=your_manager_chat_id

# App URLs
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

### База данных

Выполните SQL скрипты в Supabase SQL Editor:

1. `create_tg_link_codes.sql` - создание таблицы кодов привязки
2. `final_migration.sql` - обновление системы уровней

## 🚀 Установка и настройка

### 1. Установка зависимостей

```bash
# В корне проекта
npm install

# В папке tg-bot
cd tg-bot
npm install
```

### 2. Настройка Telegram бота

1. Создайте бота через @BotFather
2. Получите токен бота
3. Добавьте токен в `tg-bot/.env`
4. Настройте webhook (опционально)

### 3. Запуск сервисов

```bash
# Запуск Mini App
npm run dev

# Запуск Telegram бота (в отдельном терминале)
cd tg-bot
npm run dev
```

## 🔧 Настройка компонентов

### 1. Telegram Bot (tg-bot/bot.ts)

Бот обрабатывает:
- `/start <auth_code>` - привязка аккаунта
- `/my_coins` - проверка баланса SC
- `/help` - справка
- Текстовые сообщения - ИИ чат
- Команды заказа - создание заказов

### 2. AI API (app/api/ai/route.ts)

Обновлен для:
- FAQ по Spor3s Coins
- Сценарии заказов
- Синхронизация контекста
- RAG поиск инструкций

### 3. Order API (app/api/order/route.ts)

Обрабатывает:
- Создание заказов
- Применение скидок SC
- Уведомления менеджера
- Реферальные бонусы

### 4. Auth Code API (app/api/generate-auth-code/route.ts)

Генерирует коды для привязки:
- Уникальные 8-символьные коды
- Срок действия 24 часа
- Автоматическая очистка истекших кодов

## 🧪 Тестирование

### Автоматические тесты

Откройте консоль браузера и выполните:

```javascript
// Загрузите тестовый скрипт
// Скопируйте содержимое test-telegram-sync.js в консоль

// Запуск всех тестов
testTelegramSync();

// Тест конкретных сценариев
testAIScenarios();
```

### Ручное тестирование

1. **AI чат в Mini App:**
   - Откройте http://localhost:3000
   - Напишите "Привет! Расскажи о ежовике"
   - Проверьте ответ и кнопки

2. **Telegram бот:**
   - Найдите бота @web3grow
   - Отправьте `/help`
   - Напишите "Расскажи о мухоморе"
   - Проверьте ответ

3. **Привязка аккаунта:**
   - В Mini App нажмите "Привязать бота"
   - Скопируйте код
   - Отправьте `/start <код>` боту
   - Проверьте подтверждение

4. **Создание заказа:**
   - В боте напишите "ЗАКАЗ:" с данными
   - Проверьте создание заказа
   - Проверьте уведомление менеджера

## 📱 Использование

### В Mini App

1. **Чат с ИИ:**
   - Задавайте вопросы о продуктах
   - Получайте рекомендации
   - Добавляйте товары в корзину

2. **Привязка бота:**
   - Нажмите "Привязать бота"
   - Скопируйте код
   - Отправьте боту

3. **Оформление заказа:**
   - Добавьте товары в корзину
   - Заполните данные
   - Оформите заказ

### В Telegram боте

1. **Общение с ИИ:**
   - Просто напишите сообщение
   - Получите рекомендации
   - Используйте кнопки для заказа

2. **Проверка баланса:**
   - Отправьте `/my_coins`
   - Узнайте свой баланс SC

3. **Оформление заказа:**
   - Напишите "ЗАКАЗ:" с данными
   - Или используйте кнопки
   - Получите подтверждение

## 🔄 Синхронизация данных

### Сообщения

- Сохраняются в таблице `messages`
- Синхронизируются по `user_id`
- Доступны в обеих средах

### Заказы

- Создаются через единый API
- Применяются скидки SC
- Уведомляется менеджер

### Пользователи

- Создаются автоматически
- Синхронизируются по `telegram_id`
- Единый профиль в обеих средах

## 🛠️ Устранение неполадок

### Проблемы с AI чатом

```bash
# Проверьте токен OpenRouter
echo $OR_TOKEN

# Проверьте логи
tail -f .next/server.log
```

### Проблемы с Telegram ботом

```bash
# Проверьте токен бота
echo $TELEGRAM_BOT_TOKEN

# Перезапустите бота
cd tg-bot
npm run dev
```

### Проблемы с базой данных

```sql
-- Проверьте таблицы
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public';

-- Проверьте пользователей
SELECT * FROM users LIMIT 5;

-- Проверьте сообщения
SELECT * FROM messages LIMIT 5;
```

## 📞 Поддержка

- **Техническая поддержка:** @ai_ryzhov
- **Документация:** Этот README
- **Тесты:** `test-telegram-sync.js`

## 🎯 Следующие шаги

1. ✅ Синхронизация чата
2. ✅ Оформление заказов
3. ✅ Уведомления менеджера
4. 🔄 Расширенные сценарии
5. 🔄 Аналитика и метрики
6. 🔄 Автоматизация процессов